# 集群
## 概览
- Redis集群是Redis提供的分布式数据库方案，集群通过分片（sharding）来进行数据共享，并提供复制和故障转移功能
## 节点
- 一个Redis集群通常由多个节点（node）组成，在刚开始的时候，每个节点都是相互独立的，它们都处于一个只包含自己的集群当中，要组建一个真正可工作的集群，我们必须将各个独立的节点连接起来，构成一个包含多个节点的集群
- 连接各个节点的工作可以使用CLUSTER MEET命令来完成
```
CLUSTER MEET ＜ip＞ ＜port＞
```
### 启动节点
- Redis服务器在启动时会根据cluster-enabled配置选项是否为yes来决定是否开启服务器的集群模式
- 节点会继续使用所有在单机模式中使用的服务器组件
- 只有在集群模式下才会用到的数据，节点将它们保存到了cluster.h/clusterNode结构、cluster.h/clusterLink结构，以及cluster.h/clusterState结构里面
## 槽指派
- Redis集群通过分片的方式来保存数据库中的键值对：集群的整个数据库被分为16384个槽（slot）​，数据库中的每个键都属于这16384个槽的其中一个，集群中的每个节点可以处理0个或最多16384个槽。当数据库中的16384个槽都有节点在处理时，集群处于上线状态（ok）​；相反地，如果数据库中有任何一个槽没有得到处理，那么集群处于下线状态（fail）
###  记录节点的槽指派信息
- clusterNode结构的slots属性和numslot属性记录了节点负责处理哪些槽
```
struct clusterNode {
    // ...
    unsigned char slots[16384/8];
    int numslots;
    // ...
};
```
- Redis以0为起始索引，16383为终止索引，对slots数组中的16384个二进制位进行编号，并根据索引i上的二进制位的值来判断节点是否负责处理槽i
### 传播节点的槽指派信息
- 个节点除了会将自己负责处理的槽记录在clusterNode结构的slots属性和numslots属性之外，它还会将自己的slots数组通过消息发送给集群中的其他节点，以此来告知其他节点自己目前负责处理哪些槽。
###  记录集群所有槽的指派信息
- clusterState结构中的slots数组记录了集群中所有16384个槽的指派信息
### CLUSTER ADDSLOTS命令的实现
- CLUSTER ADDSLOTS命令接受一个或多个槽作为参数，并将所有输入的槽指派给接收该命令的节点负责
```
CLUSTER ADDSLOTS ＜slot＞ [slot ...]
```
## 在集群中执行命令
- 在对数据库中的16384个槽都进行了指派之后，集群就会进入上线状态
- 当客户端向节点发送与数据库键有关的命令时，接收命令的节点会计算出命令要处理的数据库键属于哪个槽，并检查这个槽
  - 如果键所在的槽正好就指派给了当前节点，那么节点直接执行这个命令
  - 如果键所在的槽并没有指派给当前节点，那么节点会向客户端返回一个MOVED错误，指引客户端转向（redirect）至正确的节点
### 节点数据库的实现
- 集群节点保存键值对以及键值对过期时间的方式，与单机Redis服务器保存键值对以及键值对过期时间的方式完全相同。区别是，节点只能使用0号数据库，而单机Redis服务器则没有这一限制。