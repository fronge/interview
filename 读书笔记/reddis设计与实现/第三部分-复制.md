# 多机数据库的实现
## 复制
- 用户可以通过执行SLAVEOF命令或者设置slaveof选项，让一个服务器去复制（replicate）另一个服务器，我们称呼被复制的服务器为主服务器（master）​，而对主服务器进行复制的服务器则被称为从服务器（slave）
- [官方文档](http://redis.io/topics/replication)
### 旧版复制功能的实现
- Redis的复制功能分为同步（sync）和命令传播（command propagate）两个操作
  - 同步操作用于将从服务器的数据库状态更新至主服务器当前所处的数据库状态
  - 命令传播操作则用于在主服务器的数据库状态被修改，导致主从服务器的数据库状态出现不一致时，让主从服务器的数据库重新回到一致状态
#### 同步
- 将从服务器的数据库状态更新至主服务器当前所处的数据库状态
- 步骤
  - 从服务器向主服务器发送SYNC命令
  - 主服务器在后台生成一个RDB文件，并使用一个缓冲区记录从现在开始执行的所有写命令
  - 当主服务器的BGSAVE命令执行完毕时，主服务器会将BGSAVE命令生成的RDB文件发送给从服务器，从服务器接收并载入这个RDB文件，将自己的数据库状态更新至主服务器执行BGSAVE命令时的数据库状态
  - 主服务器将记录在缓冲区里面的所有写命令发送给从服务器，从服务器执行这些写命令，将自己的数据库状态更新至主服务器数据库当前所处的状态

- 过程图解
<img src="https://res.weread.qq.com/wrepub/epub_622000_222">

#### 命令传播
- 主服务器会将自己执行的写命令，也即是造成主从服务器不一致的那条写命令，发送给从服务器执行，当从服务器执行了相同的写命令之后，主从服务器将再次回到一致状态.
#### 旧版复制功能的缺陷
- 从服务器终于重新连接上主服务器，因为这时主从服务器的状态已经不再一致，所以从服务器将向主服务器发送SYNC命令, SYNC 命令非常耗费资源
  - 主服务器需要执行BGSAVE命令来生成RDB文件，这个生成操作会耗费主服务器大量的CPU、内存和磁盘I/O资源
  - 主服务器需要将自己生成的RDB文件发送给从服务器，这个发送操作会耗费主从服务器大量的网络资源（带宽和流量）​，并对主服务器响应命令请求的时间产生影响。
  - 接收到RDB文件的从服务器需要载入主服务器发来的RDB文件，并且在载入期间，从服务器会因为阻塞而没办法处理命令请求。

### 新版复制功能的实现
- 为了解决旧版复制功能在处理断线重复制情况时的低效问题，Redis从2.8版本开始，使用PSYNC命令代替SYNC命令来执行复制时的同步操作
- PSYNC命令具有完整重同步（full resynchronization）和部分重同步（partial resynchronization）两种模式
  - 完整重同步用于处理初次复制情况
  - 部分重同步则用于处理断线后重复制情况
    - 服务器可以将主从服务器连接断开期间执行的写命令发送给从服务器，从服务器只要接收并执行这些写命令，就可以将数据库更新至主服务器当前所处的状态
### 部分重同步的实现
- 构成
  - 主服务器的复制偏移量（replication offset）和从服务器的复制偏移量
  - 主服务器的复制积压缓冲区（replication backlog）​
  - 服务器的运行ID（run ID）​
##### 复制偏移量
- 主服务器和从服务器会分别维护一个复制偏移量
  - 主服务器每次向从服务器传播N个字节的数据时，就将自己的复制偏移量的值加上N
  - 从服务器每次收到主服务器传播来的N个字节的数据时，就将自己的复制偏移量的值加上N
##### 复制积压缓冲区
- 复制积压缓冲区是由主服务器维护的一个固定长度（fixed-size）先进先出（FIFO）队列，默认大小为1MB
- 当从服务器重新连上主服务器时，从服务器会通过PSYNC命令将自己的复制偏移量offset发送给主服务器，主服务器会根据这个复制偏移量来决定对从服务器执行何种同步操作
  - 如果offset偏移量之后的数据（也即是偏移量offset+1开始的数据）仍然存在于复制积压缓冲区里面，那么主服务器将对从服务器执行部分重同步操作
  - 相反，如果offset偏移量之后的数据已经不存在于复制积压缓冲区，那么主服务器将对从服务器执行完整重同步操作
##### 服务器运行ID
- 每个Redis服务器，不论主服务器还是从服务，都会有自己的运行ID
- 运行ID在服务器启动时自动生成，由40个随机的十六进制字符组成
- 当从服务器对主服务器进行初次复制时，主服务器会将自己的运行ID传送给从服务器，而从服务器则会将这个运行ID保存起来
- 当从服务器断线并重新连上一个主服务器时，从服务器将向当前连接的主服务器发送之前保存的运行ID
  - 如果从服务器保存的运行ID和当前连接的主服务器的运行ID相同，那么说明从服务器断线之前复制的就是当前连接的这个主服务器，主服务器可以继续尝试执行部分重同步操作
  - 相反地，如果从服务器保存的运行ID和当前连接的主服务器的运行ID并不相同，那么说明从服务器断线之前复制的主服务器并不是当前连接的这个主服务器，主服务器将对从服务器执行完整重同步操作
### PSYNC命令的实现
- 调用方法
  - 从服务器以前没有复制过任何主服务器，或者之前执行过SLAVEOF no one命令，需要完整的复制, 将向主服务器发送PSYNC ? -1命令
  - 从服务器在之前执行过复制，但是由于某种原因与主服务器断线，需要重复制，则将向主服务器发送PSYNC ＜runid＞ ＜offset＞命令
- 主服务器的三种回复
  - 主服务器返回+FULLRESYNC ＜runid＞ ＜offset＞回复, 表示主服务器将与从服务器执行完整重同步操作
  - 主服务器返回+CONTINUE回复，那么表示主服务器将与从服务器执行部分重同步操作
  - 主服务器返回-ERR回复，那么表示主服务器的版本低于Redis 2.8，它识别不了PSYNC命令，从服务器将向主服务器发送SYNC命令，并与主服务器执行完整同步操作
### 复制的实现
- 步骤
  - 设置主服务器的地址和端口
  - 建立套接字连接
    - 从服务器是主服务器的客户端
  - 发送PING命令
    - 作用
      - 检查套接字的读写状态是否正常
      - 检查主服务器能否正常处理命令请求
    - 情况
      - 如果主服务器向从服务器返回了一个命令回复，但从服务器却不能在规定的时限（timeout）内读取出命令回复的内容，那么表示主从服务器之间的网络连接状态不佳，不能继续执行复制工作的后续步骤。当出现这种情况时，从服务器断开并重新创建连向主服务器的套接字
      - 如果主服务器向从服务器返回一个错误，那么表示主服务器暂时没办法处理从服务器的命令请求，不能继续执行复制工作的后续步骤
      - 如果从服务器读取到"PONG"回复，那么表示主从服务器之间的网络连接状态正常
  - 身份验证
    - 如果从服务器设置了masterauth选项，那么进行身份验证
    - 如果从服务器没有设置masterauth选项，那么不进行身份验证
  - 发送端口信息
    - 从服务器将执行命令REPLCONF listening-port ＜port-number＞
    - 主服务器在接收到这个命令之后，会将端口号记录在从服务器所对应的客户端状态的slave_listening_port属性
  - 同步
    - 从服务器将向主服务器发送PSYNC命令，执行同步操作，并将自己的数据库更新至主服务器数据库当前所处的状态
    - 在同步操作执行之前，只有从服务器是主服务器的客户端，但是在执行同步操作之后，主服务器也会成为从服务器的客户端
      - 如果PSYNC命令执行的是完整重同步操作，那么主服务器需要成为从服务器的客户端，才能将保存在缓冲区里面的写命令发送给从服务器执行
      - 如果PSYNC命令执行的是部分重同步操作，那么主服务器需要成为从服务器的客户端，才能向从服务器发送保存在复制积压缓冲区里面的写命令
  - 命令传播
    - 主服务器只要一直将自己执行的写命令发送给从服务器，而从服务器只要一直接收并执行主服务器发来的写命令，就可以保证主从服务器一直保持一致
### 心跳检测
- 在命令传播阶段，从服务器默认会以每秒一次的频率，向主服务器发送命令`REPLCONF ACK ＜replication_offset＞`
- 作用
  - 检测主从服务器的网络连接状态
  - 辅助实现min-slaves选项
  - 检测命令丢失
    - 如果发现丢失, 主服务器向从服务器补发缺失数据